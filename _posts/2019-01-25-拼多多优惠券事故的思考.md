---
layout: content
title: 拼多多优惠券事故的思考
status: 3
complete: 40% 
category: php
---

## 一.背景

拼多多漏洞门发生在2019年1月20日凌晨，优惠券系统被曝出现重大Bug，用户可领100元无门槛券，且并非抢购，而是无门槛领取，优惠券可全场通用（特殊商品除外），有效期一年； 该漏洞导致羊毛党和黑产狂刷，据说损失千万左右

这个事情过去一段时间了，作为一个互联网的从业者，从技术角度想写写我的思考, 首先我想到的是开发流程

## 二. 互联网产品功能的开发流程

一个互联网产品功能的诞生，会经历各种各样的开发流程，不同的团队有不同的选择，我之前管理过一个小的开发小组，会按照下面一个流程走

![开发流程](/images/manage/developflow.jpg)

从这张图，归纳起来，分成
- `四个阶段`，需求、研发、测试、线上运维，每个阶段都很重要；
- `五份文档`，产品文档，视觉文档，技术文档，提测文档，测试caselist文档，
- `四次重要会议`，需求评审会，视觉评审，技术评审会，case评审会

完成这样一个流程，需要涉及多个角色，我们来谈谈各类角色分工：

### 2.1 角色

简单的说，一个项目会涉及到下面6类角色，当然，在有些小的team，有时候，一个人会兼多个角色； 也见过在有些小公司的开发一个人兼了6个角色，这种情况下的产品在很多情况下很粗糙，就像盖的房子，茅草屋也是房子，摩天大楼也是房子，不可同日而语

1. PM： 也就是产品经理
2. UE： 视觉设计工程师
3. FE： 前端开发工程师
4. RD： 研发工程师
5. QA： 质量工程师
6. OP： 运维工程师 

实际上这些角色还会细分，例如，RD这个角色，又会分成，产品、算法、工程、架构等多个方向，产品方向，重点着手产品功能实现；算法，各种算法模型的调参，模型的建立；工程，提供内部开发者的工具开发维护，提升公司开发团队效率；架构，基础应用的开发等等；公司越大，一般角色分的越细。 

### 2.2 分工

每个角色承担的工作重点是不一样的，从需求开始，我们见过各种需求，像下面的

- "三个月，拉几十个RD，搞个淘宝出来"   --- 老板的
- "用户App的主题颜色能根据手机壳自动调整"    --- 运营的
- "家里ctrl + c复制， 公司ctrl + v 粘贴"     --- 用户的

如果这些需求就这样涌向技术团队，估计这个公司的技术团队很快就会没人了。需求的筛选，原型的设计，流程和交互文档的撰写是产品经理的日常工作； 我们用拼多多优惠券的事情的举例，产品经理交给技术手上，我认为应该包含下面几项

- 背景。 做这个事情的背景是什么？ 收益是什么？ 预估目前会有多少人去使用这个功能？ 预估一个月后会有多少人来使用这个功能？ 预估的用户的使用时间分布是怎么样的？
- 实现的功能点
    - 产品流程： 就像券，券有多少类型，每个类型的下面流程是怎么样的
        - 发放流程，平台想发券怎么发？商家想发券怎么发？
        - 领券流程，用户领券怎么领，领过后怎么展示，券的状态有哪些？
        - 注销/过期流程，商家怎么注销发放的券？系统怎么处理过期券
        - 使用流程，
    - 边界问题： 领取的门槛是什么样的，谁能用？ (地域，会员时长，年龄？ 等等)； 券的有效时间有多长；一个人能领取多少张？
- 交互流程，用户领券要经过哪些页面，每部点击了什么地方，弹框还是跳转等等
- 埋点需求，流量从什么渠道来的？用户点击了哪些按钮？用户访问的损失漏斗是怎么样的？
- A/B测试，需要A/B测试吗？标准是怎么定的？等等

产品经理的所有需求要以文档形式交给RD去实现，产品经理并不是需求转发的机器，也并不是功能实现不了就是RD的责任，技术实现的前提本身就是产品流程能够走通，一份完整好的需求文档，是一个优质项目的开始，而后，流畅的交互设计、精美的视觉设计会是用户体验的基础

技术开发的工作关注的点则会更多，一方面要理解需求，不仅仅是现在的需求，要对需求的变化有个好的把握能力，在了解完需求后，产品的技术架构设计会更富有弹性，扩展性会更强，我们在设计技术文档的时候，要关注下面几点，通常我们以模板化的文档来要求

1. 版本管理
2. 背景，技术要了解背景，要做技术调研
3. 名词解释
4. 系统环境，当前的系统环境怎么样
5. 设计目标，我们要实现的功能点有哪些，设计的性能指标是怎么样的，设计的思路，设计中是否有折衷考虑等
6. 系统设计，系统的拆分，架构图，模块的定义，模块之间的交互协议；具体的流程图
7. 接口设计，访问协议、入参、入参格式、结果、结果的格式、异常情况
8. 数据库设计/数据结构设计
9. 上线部署方案
10. 风险评估
11. 监控指标, 异常的止损原则

一个项目的开发，并不是功能实现以及测试完成后，丢到线上就结束了，实际上任何的开发的初心是什么？就是"背景和收益"，时刻记住服务用户、服务公司才是`"不忘初心"`！


## 三.思考

我们回到 "拼多多的事件", 下面是一段简要的报道

`1月20日凌晨，电商平台拼多多被曝出现重大BUG，用户可领100元无门槛券。这一漏洞引来了大批用户“薅羊毛”，并全部将优惠券用作话费充值。上午9点，拼多多已将相关优惠券全部下架。`

我们从中能问出很多问题:

1. 产品的设计文档里面提了领取规则吗？
2. 技术的设计文档里面设计实现领取规则了吗？
3. 测试的case评审文档里面覆盖领取规则的测试case了吗？
4. 技术的监控指标涉及到领取规则了吗？
5. 测试测领取规则了吗？
6. 产品验收涉及到领取规则了吗？
7. 线上领取规则下的监控指标触发报警了吗？

一个生产环境的bug，经历了足足10个小时，这里面说明了一个问题，几十个人能做一个完整的交易商城，并不代表一个交易商城几十个人就够了，如果用打分的方式来说，完成一个系统可能才20分，线上有bug可以快速报警可能30分，报警后可以半小时止损可能40分...

稳定性强，容错性好，完整链路监控，异常止损能力都是一个系统的基础指标。





