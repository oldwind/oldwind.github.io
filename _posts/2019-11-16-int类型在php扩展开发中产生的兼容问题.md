---
layout: content
title: php扩展出现的一次跨平台问题
status: 1
category: go, php
author:   "yimuren"
tags:
    - go
---

## 一. 问题描述

开发的php扩展在新环境报错，究其原因是扩展中获取字符串长度出现了问题，看一下代码(代码做了名称相关的替换)

```c
// {{{ __construct 
PHP_METHOD(Test) , __construct)
{
    const char *p0;
   	const char *p1;

	int p0_len;
	int p1_len;

	if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "ss", 
								&p0, &p0_len, 
								&p1, &p1_len) == FAILURE)
	{
		RETURN_FALSE;
	}

    ...
}
```

代码的思路比较简单，通过 `zend_parse_parameters` 方法，获取输入参数 `p0`, `p1`， 通过 `p0_len` 存储参数 `p0` 字符串的长度，这种方式在开发环境运行都是正常的，但是在docker里面运行的时候，出现了问题

- `p0 字符串有值，但是 p0_len 的长度为 0`

原因是什么？关键出现在 `int` 上，这是个不支持跨平台的参数类型

我们先一点一点梳理：

## 二. 关于 zend_parse_parameters

Zend内核提供了这个方法供php扩展获取上下文的参数输入：

```c
// num_args 参数个数
// type_spec 参数类型
ZEND_API int zend_parse_parameters(int num_args, const char *type_spec, ...)
```

一个函数的参数具备下面两个特点

1. 参数个数可变
2. 参数类型不定

解决参数可变运用的是c语言中解决变参问题的一组宏，所在头文件：#include <stdarg.h>，用于获取不确定个数的参数,

- `va_list`变量，这个变量是指向参数的指针
- `va_start`函数，初始化 `va_list` 变量
- `va_arg`函数返回可变的参数，va_arg 的第二个参数是要获取的参数的类型；va_arg在获取到参数后，会把 va_list变量指针向下移动一个位置
- `va_end` 函数结束可变参数的获取

```c
ZEND_API int zend_parse_parameters(int num_args, const char *type_spec, ...) /* {{{ */
{
	va_list va;
	int retval;
	int flags = 0;

	va_start(va, type_spec);
	retval = zend_parse_va_args(num_args, type_spec, &va, flags);
	va_end(va);

	return retval;
}
```

在进程中,堆栈地址是从高到低分配的.当执行一个函数的时候,将参数列表入栈,压入堆栈的高地址部分,然后入栈函数的返回地址,接着入栈函数的执行代码,这个入栈过程,堆栈地址不断递减。
同时，堆栈中,各个参数的分布情况是倒序的.即最后一个参数在列表中地址最高部分,第一个参数在列表地址的最低部分

了解完获取不定参数的问题后，下面的问题是关于参数的类型，Zend内核支持不同的字符来表示 参数的类型，下面是一个对应参数的类型表

参数	代表着的类型
b	Boolean
l	Integer
d	Float
s	String
r	Resource
a	Array
o	Object
O	特定类型的Object
z	任意类型
Z	zval**类型
f	表示函数、方法名称


参数	对应C里的数据类型
b	zend_bool
l	long
d	double
s	char*, int 前者接收指针，后者接收长度
r	zval*
a	zval*
o	zval*
O	zval*, zend_class_entry*
z	zval*
Z	zval**